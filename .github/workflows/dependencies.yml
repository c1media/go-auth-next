name: 🔄 Dependencies

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Update Go Dependencies
  update-go-deps:
    name: 🐹 Update Go Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 🐹 Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: 🔄 Update Go dependencies
      working-directory: ./authserver
      run: |
        go get -u ./...
        go mod tidy

    - name: 🧪 Test with updated dependencies
      working-directory: ./authserver
      run: go test ./...

    - name: 📝 Create Pull Request for Go deps
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: '🔄 Update Go dependencies'
        title: '🔄 Update Go dependencies'
        body: |
          This PR updates Go dependencies to their latest versions.
          
          Changes:
          - Updated all Go modules to latest versions
          - Ran `go mod tidy` to clean up
          - All tests pass with updated dependencies
        branch: update-go-dependencies
        delete-branch: true

  # Update npm Dependencies
  update-npm-deps:
    name: 📦 Update npm Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 📦 Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 🔄 Update npm dependencies
      working-directory: ./front-end
      run: |
        npx npm-check-updates -u
        npm install

    - name: 🧪 Test with updated dependencies
      working-directory: ./front-end
      run: |
        npm run lint
        npm run type-check
        npm run build

    - name: 📝 Create Pull Request for npm deps
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: '📦 Update npm dependencies'
        title: '📦 Update npm dependencies'
        body: |
          This PR updates npm dependencies to their latest versions.
          
          Changes:
          - Updated all npm packages to latest versions
          - All linting, type checking, and build tests pass
        branch: update-npm-dependencies
        delete-branch: true

  # Security Updates
  security-updates:
    name: 🔒 Security Updates
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔒 Check for security updates
      run: |
        echo "🔍 Checking for security vulnerabilities..."
        
        # Check Go vulnerabilities
        go install golang.org/x/vuln/cmd/govulncheck@latest
        cd authserver && govulncheck ./...
        
        # Check npm vulnerabilities
        cd ../front-end && npm audit

    - name: 📢 Create security issue if vulnerabilities found
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🚨 Security vulnerabilities detected',
            body: `Security vulnerabilities have been detected in dependencies.
            
            Please review the CI logs and update vulnerable packages:
            - Check Go vulnerabilities with \`govulncheck\`
            - Check npm vulnerabilities with \`npm audit\`
            
            Triggered by: ${{ github.workflow }} workflow`,
            labels: ['security', 'dependencies']
          })